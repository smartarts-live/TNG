<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>brain-TRAINer! - Body & Soul</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231ABC9C'/><text x='50%' y='50%' font-family='Arial, sans-serif' font-size='50' font-weight='bold' fill='%23FFFFFF' dominant-baseline='central' text-anchor='middle'>CP</text></svg>">
    <style>
        :root { --bg: #1A252F; --box: #243447; --text: #ECF0F1; --mint: #1ABC9C; --mint-glow: rgba(26, 188, 156, 0.3); }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; user-select: none; overflow: hidden; }
        .container { background: var(--box); width: 100%; max-width: 700px; padding: 50px; border-radius: 12px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); text-align: center; }
        h1 { color: var(--mint); margin-top: 0; font-size: 2.2rem; }
        p.instruction { font-size: 1.2rem; color: #BDC3C7; margin-bottom: 40px; line-height: 1.6; }
        button.control-btn { background: var(--mint); color: #1A252F; font-size: 1.3rem; padding: 18px 50px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px var(--mint-glow); }
        button.secondary-btn { background: transparent; border: 2px solid #7F8C8D; color: #7F8C8D; font-size: 1rem; padding: 12px 30px; border-radius: 6px; cursor: pointer; margin-top: 20px; }
        
        #active-screen, #done-screen { display: none; }
        
        .breathing-container { position: relative; width: 250px; height: 250px; margin: 40px auto; display: flex; align-items: center; justify-content: center; }
        .breathing-circle { width: 100px; height: 100px; background: radial-gradient(circle, var(--mint) 0%, transparent 80%); border-radius: 50%; opacity: 0.8; animation: breathe 10s infinite ease-in-out; box-shadow: 0 0 40px var(--mint-glow); }
        @keyframes breathe { 0% { transform: scale(1); opacity: 0.5; } 40% { transform: scale(2.5); opacity: 1; } 100% { transform: scale(1); opacity: 0.5; } }
        
        .breath-text { position: absolute; font-size: 1.2rem; font-weight: bold; color: #FFF; text-shadow: 0 2px 4px rgba(0,0,0,0.5); animation: textFade 10s infinite ease-in-out; }
        @keyframes textFade { 0% { content: "Einatmen..."; opacity: 0.5; } 20% { opacity: 1; } 40% { content: "Ausatmen..."; opacity: 1; } 90% { opacity: 0.5; } 100% { content: "Einatmen..."; opacity: 0.5; } }
        
        .ex-title { font-size: 2rem; font-weight: bold; color: var(--mint); margin-bottom: 10px; }
        .ex-desc { font-size: 1.2rem; color: #ECF0F1; line-height: 1.5; min-height: 60px; margin-bottom: 20px; }
        .timer-display { font-size: 3rem; font-family: monospace; font-weight: bold; color: #BDC3C7; margin-bottom: 20px; }
        .progress-bar-bg { width: 100%; height: 6px; background: #34495E; border-radius: 3px; overflow: hidden; margin-top: 40px; }
        .progress-bar-fill { height: 100%; background: var(--mint); width: 0%; transition: width 1s linear; }
    </style>
</head>
<body>
    <div class="container">
        <div id="start-screen">
            <h1>Body & Soul</h1>
            <p class="instruction">
                <strong>Biohacking-Session.</strong><br><br>
                Der Browser generiert nun ein atmendes <em>Brown Noise</em>, um dich abzuschirmen.<br>
                Folge den strukturierten Dehnübungen und passe deine Atmung an.
            </p>
            <button class="control-btn" onclick="startSession()">AUDIO & SESSION STARTEN</button><br>
            <button class="secondary-btn" onclick="window.location.href='index.html'">Zurück zum Dashboard</button>
        </div>

        <div id="active-screen">
            <div class="ex-title" id="ex-title">Lädt...</div>
            <div class="ex-desc" id="ex-desc">...</div>
            <div class="breathing-container"><div class="breathing-circle"></div><div class="breath-text" id="breath-indicator">Einatmen...</div></div>
            <div class="timer-display" id="ex-timer">30</div>
            <div class="progress-bar-bg"><div class="progress-bar-fill" id="progress-bar"></div></div>
        </div>

        <div id="done-screen">
            <h1 style="font-size: 3rem;">Session Beendet</h1>
            <p class="instruction">Dein Nervensystem ist kalibriert.</p>
            <p style="font-size: 2rem; color: var(--mint);" id="redirect-timer">Weiter in 3...</p>
        </div>
    </div>

    <script>
        // Übungs-Blöcke (Damit Links/Rechts IMMER zusammenhängen)
        const exerciseBlocks = [
            [{ title: "Nacken-Release (Links)", desc: "Linkes Ohr sanft zur linken Schulter neigen. Schultern tief.", time: 30 },
             { title: "Nacken-Release (Rechts)", desc: "Rechtes Ohr sanft zur rechten Schulter neigen. Schultern tief.", time: 30 }],
            [{ title: "Handgelenk (Links)", desc: "Linken Arm ausstrecken, Finger nach oben. Sanft zum Körper ziehen.", time: 30 },
             { title: "Handgelenk (Rechts)", desc: "Rechten Arm ausstrecken, Finger nach oben. Sanft zum Körper ziehen.", time: 30 }],
            [{ title: "Spinal Twist (Links aufdrehen)", desc: "Rechte Hand ans linke Knie, Oberkörper nach links aufdrehen.", time: 30 },
             { title: "Spinal Twist (Rechts aufdrehen)", desc: "Linke Hand ans rechte Knie, Oberkörper nach rechts aufdrehen.", time: 30 }],
            [{ title: "Brust-Öffner", desc: "Hände hinter dem Rücken verschränken, Brustkorb stolz nach vorne.", time: 30 }],
            [{ title: "Augen-Palming", desc: "Handflächen warm reiben. Geschlossen über die Augen legen. Dunkelheit genießen.", time: 30 }],
            [{ title: "Schulter-Rollen", desc: "Schultern weit hoch zu den Ohren ziehen und kreisend nach hinten unten abrollen.", time: 30 }]
        ];

        let sessionExercises = []; let currentExIndex = 0; let timeLeft = 0; let exerciseTimer;
        
        let audioCtx; let gainNode; let filterNode; let isSessionActive = false;

        function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();

            const bufferSize = audioCtx.sampleRate * 2;
            const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            let lastOut = 0;
            for (let i = 0; i < bufferSize; i++) {
                let white = Math.random() * 2 - 1;
                output[i] = (lastOut + (0.02 * white)) / 1.02;
                lastOut = output[i];
                output[i] *= 3.5; 
            }

            const noiseSource = audioCtx.createBufferSource();
            noiseSource.buffer = noiseBuffer; noiseSource.loop = true;

            // Biquad-Filter für die "Atmung" des Meeresrauschens
            filterNode = audioCtx.createBiquadFilter();
            filterNode.type = 'lowpass';
            filterNode.frequency.value = 400; // Startwert (dumpf)

            gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);

            noiseSource.connect(filterNode);
            filterNode.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            noiseSource.start();
            isSessionActive = true;
            scheduleBreathModulation(); // Startet den Atemzyklus
        }

        // Automatisiert die Filter-Frequenz passend zur visuellen 4s / 6s Atmung
        function scheduleBreathModulation() {
            if(!isSessionActive) return;
            const t = audioCtx.currentTime;
            
            // EINATMEN (0 bis 4 Sekunden) -> Filter öffnet sich (Welle kommt)
            filterNode.frequency.setValueAtTime(300, t);
            filterNode.frequency.linearRampToValueAtTime(1500, t + 4);
            gainNode.gain.setValueAtTime(0.2, t);
            gainNode.gain.linearRampToValueAtTime(0.8, t + 4);

            // AUSATMEN (4 bis 10 Sekunden) -> Filter schließt sich (Welle geht)
            filterNode.frequency.linearRampToValueAtTime(300, t + 10);
            gainNode.gain.linearRampToValueAtTime(0.2, t + 10);

            // Rekursiver Aufruf alle 10 Sekunden
            setTimeout(() => { scheduleBreathModulation(); }, 10000);
        }

        function startSession() {
            initAudio();
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('active-screen').style.display = 'block';

            // Baue den Flow: Wähle zufällige Blöcke bis wir ca. 4-6 Übungen haben
            sessionExercises = [];
            const shuffledBlocks = [...exerciseBlocks].sort(() => 0.5 - Math.random());
            for(let block of shuffledBlocks) {
                sessionExercises.push(...block);
                if(sessionExercises.length >= 4) break; // Zieht so lange, bis Ziel erreicht ist
            }

            // Visueller Text
            const breathIndicator = document.getElementById('breath-indicator');
            let isEinatmen = true; breathIndicator.innerText = "Einatmen...";
            setInterval(() => {
                isEinatmen = !isEinatmen;
                breathIndicator.innerText = isEinatmen ? "Einatmen..." : "Ausatmen...";
            }, isEinatmen ? 4000 : 6000);

            loadExercise();
        }

        function loadExercise() {
            if (currentExIndex >= sessionExercises.length) { endSession(); return; }
            const ex = sessionExercises[currentExIndex];
            document.getElementById('ex-title').innerText = ex.title;
            document.getElementById('ex-desc').innerText = ex.desc;
            timeLeft = ex.time; document.getElementById('ex-timer').innerText = timeLeft;
            
            document.getElementById('progress-bar').style.width = `${(currentExIndex / sessionExercises.length) * 100}%`;

            clearInterval(exerciseTimer);
            exerciseTimer = setInterval(() => {
                timeLeft--; document.getElementById('ex-timer').innerText = timeLeft;
                if (timeLeft <= 0) { clearInterval(exerciseTimer); currentExIndex++; loadExercise(); }
            }, 1000);
        }

        function endSession() {
            clearInterval(exerciseTimer); isSessionActive = false;
            document.getElementById('progress-bar').style.width = '100%';
            
            if(gainNode) gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 3);
            
            document.getElementById('active-screen').style.display = 'none';
            document.getElementById('done-screen').style.display = 'block';

            let redirectTime = 3;
            let rtInterval = setInterval(() => {
                redirectTime--; document.getElementById('redirect-timer').innerText = `Weiter in ${redirectTime}...`;
                if(redirectTime <= 0) { clearInterval(rtInterval); window.location.href = 'index.html'; }
            }, 1000);
        }
    </script>
</body>
</html>
